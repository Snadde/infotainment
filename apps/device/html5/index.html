<!DOCTYPE HTML>
<html>
<head>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script type="text/javascript">
var ws;
$(document).ready(function(){
  //reset();
	 
  $("#connect").click(function(){
	$("#status").text('Connected?');
    $("#connect").hide();
    $("#disconnect").show();
    $("#init").show();
	ConnectWebsocket();
	
  });
  $("#init").click(function(){
    $(this).hide();
	$("#status").text('Initiating');
	Init();
  });
  $("#install").click(function(){
    $(this).hide();
    //$("#start").show();
	$("#status").text('Installing..');
	Install();
  });
  $("#uninstall").click(function(){
    $(this).hide();
    //$("#start").show();
	$("#status").text('Uninstalling..');
	UnInstall();
  });
  $("#start").click(function(){
    $(this).hide();
    $("#stop").show();
	$("#status").text('Starting..');
	Start();
  });
  $("#stop").click(function(){
    $(this).hide();
    $("#start").show();
	$("#status").text('Installing..');
	Stop();
  });
  $("#disconnect").click(function(){
    $(this).hide();
    //$("#start").show();
	$("#status").text('Disconnected..');
  });
  $("#update").click(function(){
    $(this).hide();
	$("#status").text('Updating..');
	Update();
  });
  
 });
function ConnectWebsocket()
{
  if ("WebSocket" in window)
  {
  	 ws = new WebSocket("ws://localhost:3000/echo");
     // Let us open a web socket
     ws.onopen = function()
     {
        //alert("WebSocket is UP!");
		//ws.send('{"action":"init","topic":"mintopic"}');
		//ws.send('{"action":"install","topic":"mintopic"}');
		//ws.send('{"action":"start","topic":"mintopic"}');
		//ws.send('{"action":"stop","topic":"mintopic"}');
		//ws.send('{"action":"uninstall","topic":"mintopic"}');
        //alert("Message is sent...");
     };
     ws.onmessage = function (evt) 
     { 
        var mqttmessage = JSON.parse(evt.data);
		var message = JSON.parse(mqttmessage.payload);
        if(message.action == 'initresponse')
		{
			if(message.data == 'install'){
				//ws.send('{"action":"install","url":"http://infotainment.danielkvist.net/webapp.zip"}');
				$("#install").show();
				$("#status").text('No app installed');
			}
			else if(message.data == 'start'){
				$("#start").show();
				$("#uninstall").show();
				$("#status").text('app installed...');
				ws.send('{"action":"start","topic":"mintopic"}');
			}
			else if(message.data == 'update'){
				$("#update").show();
				$("#uninstall").show();
				$("#status").text('new version found please install...');
			}
		}
		//alert(message);
		
     };
     ws.onclose = function()
     { 
        // websocket is closed.
        //alert("Connection is closed...");
		$("#status").text("Connection is lost...");
	    reset();
     };
  }
  else
  {
     // The browser doesn't support WebSocket
     alert("WebSocket NOT supported by your Browser!");
  }
};
function Init(){
	ws.send('{"action":"init","data":"mintopic"}');
};
function Install(){
	ws.send('{"action":"install","url":"http://infotainment.danielkvist.net/webapp.zip"}');
};
function Update(){
	ws.send('{"action":"update","url":"http://infotainment.danielkvist.net/webapp.zip"}');
};
function UnInstall(){
	ws.send('{"action":"uninstall","data":"mintopic"}');
};
function Start(){
	ws.send('{"action":"start","data":"mintopic"}');
};
function Stop(){
	ws.send('{"action":"stop","data":"mintopic"}');
};

function reset(){
    $("#connect").show();
	$("#start").hide();
    $("#init").hide();
    $("#install").hide(); 
    $("#backup").hide();
    $("#uninstall").hide();
    $("#stop").hide();
    $("#disconnect").hide();
    $("#update").hide();
    $("#status").text("Not Connected...");
};

</script>
</head>
	<h1 id ='header'>
		Welcome to the coolest app in the world!
	</h1>
	<h2 id ='status'>
		Not Connected
	</h2>
	<body>
		<button id="connect">
			Connect WebSocket
		</button>
		<button id = "init">
			Init
		</button>
		<button id = "install">
			Install
		</button>
 	    <button id = "uninstall">
		   	Uninstall
	    </button>
	    <button id = "start">
		   	Start Application
	    </button>
 	    <button id = "stop">
		  	Stop Application
	    </button>
 	    <button id = "disconnect">
		 	Disconnect websocket
	 	</button>
 	    <button id = "update">
		 	Update Application
	 	</button>
	 	<div id = "backup">
			 <a href="javascript:WebSocketTest()">Connect WebSocket</a>
	 	</div>
	</body>
</html>
